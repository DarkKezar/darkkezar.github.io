!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.SuperGif=t()}(this,function(){var e=function(e){return e.reduce(function(e,t){return 2*e+t},0)},t=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},n=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},r=function(e,t){for(var n,r,a=0,i=[],o=1<<e,l=o+1,s=e+1,c=[];;){if(r=n,(n=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(a>>3)&1<<(7&a)&&(n|=1<<r),a++;return n}(s))===o){!function(){c=[],s=e+1;for(var t=0;t<o;t++)c[t]=[t];c[o]=[],c[l]=null}();continue}if(n===l)break;if(n<c.length)r!==o&&c.push(c[r].concat(c[n][0]));else{if(n!==c.length)throw Error("Invalid LZW code.");c.push(c[r].concat(c[r][0]))}i.push.apply(i,c[n]),c.length===1<<s&&s<12&&s++}return i},a=function(n,a){a||(a={});var i=function(e){for(var t=[],r=0;r<e;r++)t.push(n.readBytes(3));return t},o=function(){var e,t;t="";do e=n.readByte(),t+=n.read(e);while(0!==e);return t},l=function(r){var i,l,s,c,h,d,u,p;switch(r.label=n.readByte(),r.label){case 249:r.extType="gce",i=r,n.readByte(),l=t(n.readByte()),i.reserved=l.splice(0,3),i.disposalMethod=e(l.splice(0,3)),i.userInput=l.shift(),i.transparencyGiven=l.shift(),i.delayTime=n.readUnsigned(),i.transparencyIndex=n.readByte(),i.terminator=n.readByte(),a.gce&&a.gce(i);break;case 254:r.extType="com",(s=r).comment=o(),a.com&&a.com(s);break;case 1:r.extType="pte",c=r,n.readByte(),c.ptHeader=n.readBytes(12),c.ptData=o(),a.pte&&a.pte(c);break;case 255:r.extType="app",d=r,(n.readByte(),d.identifier=n.read(8),d.authCode=n.read(3),"NETSCAPE"===d.identifier)?(u=d,n.readByte(),u.unknown=n.readByte(),u.iterations=n.readUnsigned(),u.terminator=n.readByte(),a.app&&a.app.NETSCAPE&&a.app.NETSCAPE(u)):((p=d).appData=o(),a.app&&a.app[p.identifier]&&a.app[p.identifier](p));break;default:r.extType="unknown",(h=r).data=o(),a.unknown&&a.unknown(h)}},s=function(l){l.leftPos=n.readUnsigned(),l.topPos=n.readUnsigned(),l.width=n.readUnsigned(),l.height=n.readUnsigned();var s=t(n.readByte());l.lctFlag=s.shift(),l.interlaced=s.shift(),l.sorted=s.shift(),l.reserved=s.splice(0,2),l.lctSize=e(s.splice(0,3)),l.lctFlag&&(l.lct=i(1<<l.lctSize+1)),l.lzwMinCodeSize=n.readByte();var c=o();l.pixels=r(l.lzwMinCodeSize,c),l.interlaced&&(l.pixels=function(e,t){for(var n=Array(e.length),r=e.length/t,a=[0,4,2,1],i=[8,8,4,2],o=0,l=0;l<4;l++)for(var s=a[l];s<r;s+=i[l])(function(r,a){var i=e.slice(a*t,(a+1)*t);n.splice.apply(n,[r*t,t].concat(i))})(s,o),o++;return n}(l.pixels,l.width)),a.img&&a.img(l)},c=function(){var e={};switch(e.sentinel=n.readByte(),String.fromCharCode(e.sentinel)){case"!":e.type="ext",l(e);break;case",":e.type="img",s(e);break;case";":e.type="eof",a.eof&&a.eof(e);break;default:throw Error("Unknown block: 0x"+e.sentinel.toString(16))}"eof"!==e.type&&setTimeout(c,0)};(function(){var r={};if(r.sig=n.read(3),r.ver=n.read(3),"GIF"!==r.sig)throw Error("Not a GIF file.");r.width=n.readUnsigned(),r.height=n.readUnsigned();var o=t(n.readByte());r.gctFlag=o.shift(),r.colorRes=e(o.splice(0,3)),r.sorted=o.shift(),r.gctSize=e(o.splice(0,3)),r.bgColor=n.readByte(),r.pixelAspectRatio=n.readByte(),r.gctFlag&&(r.gct=i(1<<r.gctSize+1)),a.hdr&&a.hdr(r)})(),setTimeout(c,0)};return function(e){var t,r,i,o,l,s,c={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var h in e)c[h]=e[h];c.vp_w&&c.vp_h&&(c.is_vp=!0);var d=null,u=!1,p=null,f=null,g=null,$=null,y=null,w=null,v=null,m=!0,_=!1,x=[],b=[],B=c.gif;void 0===c.auto_play&&(c.auto_play=!B.getAttribute("rel:auto_play")||"1"==B.getAttribute("rel:auto_play"));var C,P,T,k,S,E,A,F,I,O=c.hasOwnProperty("on_end")?c.on_end:null,U=c.hasOwnProperty("loop_delay")?c.loop_delay:0,z=c.hasOwnProperty("loop_mode")?c.loop_mode:"auto",N=!c.hasOwnProperty("draw_while_loading")||c.draw_while_loading,R=!!N&&(!c.hasOwnProperty("show_progress_bar")||c.show_progress_bar),D=c.hasOwnProperty("progressbar_height")?c.progressbar_height:25,G=c.hasOwnProperty("progressbar_background_color")?c.progressbar_background_color:"rgba(255,255,255,0.4)",M=c.hasOwnProperty("progressbar_foreground_color")?c.progressbar_foreground_color:"rgba(255,0,22,.8)",j=function(){p=null,f=null,y=g,g=null,w=null},W=function(){try{a(t,en)}catch(e){Z("parse")}},H=function(e,t){i.width=e*ea(),i.height=t*ea(),l.style.minWidth=e*ea()+"px",s.width=e,s.height=t,s.style.width=e+"px",s.style.height=t+"px",s.getContext("2d").setTransform(1,0,0,1,0,0)},q=function(e,t){if(!b[e]){b[e]=t;return}void 0!==t.x&&(b[e].x=t.x),void 0!==t.y&&(b[e].y=t.y)},L=function(e,t,n){if(n&&R){var r,a,l,s,h=D;c.is_vp?_?(l=(c.vp_t+c.vp_h-h)/ea(),h/=ea(),a=(r=c.vp_l/ea())+e/t*(c.vp_w/ea()),s=i.width/ea()):(l=c.vp_t+c.vp_h-h,a=(r=c.vp_l)+e/t*c.vp_w,s=i.width):(l=(i.height-h)/(_?ea():1),a=e/t*i.width/(_?ea():1),s=i.width/(_?ea():1),h/=_?ea():1),o.fillStyle=G,o.fillRect(a,l,s-a,h),o.fillStyle=M,o.fillRect(0,l,a,h)}},Z=function(e){d=e,r={width:B.width,height:B.height},x=[],o.fillStyle="black",o.fillRect(0,0,c.c_w?c.c_w:r.width,c.c_h?c.c_h:r.height),o.strokeStyle="red",o.lineWidth=3,o.moveTo(0,0),o.lineTo(c.c_w?c.c_w:r.width,c.c_h?c.c_h:r.height),o.moveTo(0,c.c_h?c.c_h:r.height),o.lineTo(c.c_w?c.c_w:r.width,0),o.stroke()},J=function(e){H((r=e).width,r.height)},K=function(e){Q(),j(),p=e.transparencyGiven?e.transparencyIndex:null,f=e.delayTime,g=e.disposalMethod},Q=function(){w&&(x.push({data:w.getImageData(0,0,r.width,r.height),delay:f}),b.push({x:0,y:0}))},V=function(e){w||(w=s.getContext("2d"));var t=x.length,n=e.lctFlag?e.lct:r.gct;t>0&&(3===y?null!==$?w.putImageData(x[$].data,0,0):w.clearRect(v.leftPos,v.topPos,v.width,v.height):$=t-1,2===y&&w.clearRect(v.leftPos,v.topPos,v.width,v.height));var a=w.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach(function(e,t){e!==p&&(a.data[4*t+0]=n[e][0],a.data[4*t+1]=n[e][1],a.data[4*t+2]=n[e][2],a.data[4*t+3]=255)}),w.putImageData(a,e.leftPos,e.topPos),_||(o.scale(ea(),ea()),_=!0),N&&(o.drawImage(s,0,0),N=c.auto_play),v=e},X=(C=-1,P=0,T=function(e){C+=e,F()},A=(k=!1,S=function(){null!==O&&O(B),P++,!1!==z||P<0?E():(k=!1,m=!1)},E=function(){if(k=m){T(1);var e=10*x[C].delay;e||(e=100),0==(C+1+x.length)%x.length?setTimeout(S,e+=U):setTimeout(E,e)}},function(){k||setTimeout(E,0)}),F=function(){var e;(C=parseInt(C,10))>x.length-1&&(C=0),C<0&&(C=0),e=b[C],s.getContext("2d").putImageData(x[C].data,e.x,e.y),o.globalCompositeOperation="copy",o.drawImage(s,0,0)},I=function(){m=!0,A()},{init:function(){d||(c.c_w&&c.c_h||o.scale(ea(),ea()),c.auto_play?A():(C=0,F()))},step:A,play:I,pause:function(){m=!1},playing:m,move_relative:T,current_frame:function(){return C},length:function(){return x.length},move_to:function(e){C=e,F()}}),Y=function(e){L(t.pos,t.data.length,e)},ee=function(){},et=function(e,t){return function(n){e(n),Y(t)}},en={hdr:et(J),gce:et(K),com:et(ee),app:{NETSCAPE:et(ee)},img:et(V,!0),eof:function(e){Q(),Y(!1),c.c_w&&c.c_h||(i.width=r.width*ea(),i.height=r.height*ea()),X.init(),u=!1,eo&&eo(B)}},er=function(){var e=B.parentNode,t=document.createElement("div");o=(i=document.createElement("canvas")).getContext("2d"),l=document.createElement("div"),s=document.createElement("canvas"),t.width=i.width=B.width,t.height=i.height=B.height,l.style.minWidth=B.width+"px",t.className="jsgif",l.className="jsgif_toolbar",t.appendChild(i),t.appendChild(l),e.insertBefore(t,B),e.removeChild(B),c.c_w&&c.c_h&&H(c.c_w,c.c_h),ei=!0},ea=function(){var e;return c.max_width&&r&&r.width>c.max_width?c.max_width/r.width:1},ei=!1,eo=!1,el=function(e){return!u&&(eo=!!e&&e,u=!0,x=[],j(),$=null,y=null,w=null,v=null,!0)};return{play:X.play,pause:X.pause,move_relative:X.move_relative,move_to:X.move_to,get_playing:function(){return m},get_canvas:function(){return i},get_canvas_scale:function(){return ea()},get_loading:function(){return u},get_auto_play:function(){return c.auto_play},get_length:function(){return X.length()},get_current_frame:function(){return X.current_frame()},load_url:function(e,r){if(el(r)){var a=new XMLHttpRequest;a.open("GET",e,!0),"overrideMimeType"in a?a.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in a?a.responseType="arraybuffer":a.setRequestHeader("Accept-Charset","x-user-defined"),a.onloadstart=function(){ei||er()},a.onload=function(e){200!=this.status&&Z("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var r=this.response;r.toString().indexOf("ArrayBuffer")>0&&(r=new Uint8Array(r)),t=new n(r),setTimeout(W,0)},a.onprogress=function(e){e.lengthComputable&&L(e.loaded,e.total,!0)},a.onerror=function(){Z("xhr")},a.send()}},load:function(e){this.load_url(B.getAttribute("rel:animated_src")||B.src,e)},load_raw:function(e,r){el(r)&&(ei||er(),t=new n(e),setTimeout(W,0))},set_frame_offset:q}}});